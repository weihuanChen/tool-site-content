# 快速开始 - Supabase 配置

## 概述

本指南将帮助您快速配置 Strapi 项目以使用 Supabase 作为数据库。

## 方法一：使用自动化脚本（推荐）

### 1. 安装 PostgreSQL 依赖
```bash
npm run install:pg
```

### 2. 运行设置脚本
```bash
# 交互式设置（推荐）
npm run setup:supabase

# 或者使用快速设置脚本
npm run setup:supabase:quick
```

### 3. 启动开发服务器
```bash
npm run develop
```

## 方法二：手动配置

### 1. 安装 PostgreSQL 依赖
```bash
npm install pg
```

### 2. 创建 .env 文件
在项目根目录创建 `.env` 文件：

```bash
# 应用基础配置
APP_KEYS=your-app-keys-here
HOST=0.0.0.0
PORT=1337

# 数据库配置 (Supabase PostgreSQL)
DATABASE_CLIENT=postgres
DATABASE_URL=postgresql://postgres:[YOUR_PASSWORD]@db.[YOUR_PROJECT_REF].supabase.co:5432/postgres
DATABASE_HOST=db.[YOUR_PROJECT_REF].supabase.co
DATABASE_PORT=5432
DATABASE_NAME=postgres
DATABASE_USERNAME=postgres
DATABASE_PASSWORD=[YOUR_PASSWORD]
DATABASE_SSL=true
DATABASE_SSL_REJECT_UNAUTHORIZED=false
DATABASE_POOL_MIN=2
DATABASE_POOL_MAX=10
DATABASE_CONNECTION_TIMEOUT=60000
DATABASE_SCHEMA=public

# 安全配置 (必需)
ADMIN_JWT_SECRET=your-admin-jwt-secret-here
API_TOKEN_SALT=your-api-token-salt-here
TRANSFER_TOKEN_SALT=your-transfer-token-salt-here
ENCRYPTION_KEY=your-encryption-key-here

# 功能标志
FLAG_NPS=true
FLAG_PROMOTE_EE=true

# 开发环境配置
NODE_ENV=development
LOG_LEVEL=info
```

### 3. 生成安全密钥
```bash
# 生成应用密钥
node -e "console.log('APP_KEYS=' + require('crypto').randomBytes(32).toString('base64'))"

# 生成管理员 JWT 密钥
node -e "console.log('ADMIN_JWT_SECRET=' + require('crypto').randomBytes(64).toString('base64'))"

# 生成 API 令牌盐值
node -e "console.log('API_TOKEN_SALT=' + require('crypto').randomBytes(32).toString('base64'))"

# 生成传输令牌盐值
node -e "console.log('TRANSFER_TOKEN_SALT=' + require('crypto').randomBytes(32).toString('base64'))"

# 生成数据加密密钥
node -e "console.log('ENCRYPTION_KEY=' + require('crypto').randomBytes(32).toString('base64'))"
```

### 4. 更新 .env 文件
将生成的密钥替换 `.env` 文件中的占位符，并填入您的 Supabase 项目信息。

## 获取 Supabase 连接信息

### 1. 登录 Supabase
访问 [Supabase](https://supabase.com) 并登录您的账户。

### 2. 选择项目
选择您要使用的项目，或创建新项目。

### 3. 获取连接信息
1. 进入 **Settings** > **Database**
2. 找到 **Connection string** 部分
3. 选择 **URI** 格式
4. 复制连接字符串

连接字符串格式：
```
postgresql://postgres:[YOUR_PASSWORD]@db.[YOUR_PROJECT_REF].supabase.co:5432/postgres
```

**重要提醒**：请确保连接字符串中不包含 `https://` 前缀，正确的格式是 `db.[YOUR_PROJECT_REF].supabase.co`，而不是 `db.https://[YOUR_PROJECT_REF].supabase.co`。

## 验证配置

### 1. 启动开发服务器
```bash
npm run develop
```

### 2. 检查连接状态
如果配置正确，您应该看到：
- 数据库连接成功
- 服务器启动在 `http://localhost:1337`
- 管理面板可在 `http://localhost:1337/admin` 访问

### 3. 创建管理员账户
首次启动时，系统会提示您创建管理员账户。

## 故障排除

### 常见问题

1. **SSL 连接错误**
   - 确保 `DATABASE_SSL=true`
   - 确保 `DATABASE_SSL_REJECT_UNAUTHORIZED=false`

2. **连接超时**
   - 检查网络连接
   - 验证 Supabase 项目是否处于活动状态

3. **认证失败**
   - 验证数据库密码是否正确
   - 检查项目引用 ID 是否正确

4. **权限错误**
   - 确保 Supabase 项目已正确配置
   - 检查数据库用户权限

5. **连接格式错误**
   - 确保 `DATABASE_URL` 格式正确：`postgresql://postgres:[PASSWORD]@db.[PROJECT_REF].supabase.co:5432/postgres`
   - 确保 `DATABASE_HOST` 格式正确：`db.[PROJECT_REF].supabase.co`
   - 不要包含 `https://` 前缀在主机名中

### 调试模式
```bash
DEBUG=strapi:* npm run develop
```

## 下一步

配置完成后，您可以：

1. **创建内容类型** - 定义您的数据结构
2. **配置 API 权限** - 设置访问控制
3. **自定义管理面板** - 优化用户体验
4. **部署到生产环境** - 发布您的应用

## 安全提醒

- 确保 `.env` 文件已添加到 `.gitignore`
- 不要将 `.env` 文件提交到版本控制系统
- 定期轮换密钥
- 使用强密码

## 需要帮助？

- 查看 [Supabase 配置指南](./Supabase配置指南.md) 获取详细说明
- 查看 [技术架构文档](./技术架构.md) 了解系统架构
- 查看 [API 文档](./API文档.md) 了解 API 使用
