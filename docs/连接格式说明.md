# Supabase 连接格式说明

## 概述

本文档详细说明了 Supabase 数据库连接的正确格式，以及常见的格式错误和解决方案。

## 正确的连接格式

### 1. DATABASE_URL 格式
```bash
# ✅ 正确格式
DATABASE_URL=postgresql://postgres:[PASSWORD]@db.[PROJECT_REF].supabase.co:5432/postgres

# ❌ 错误格式
DATABASE_URL=postgresql://postgres:[PASSWORD]@db.https://[PROJECT_REF].supabase.co:5432/postgres
DATABASE_URL=postgresql://postgres:[PASSWORD]@https://[PROJECT_REF].supabase.co:5432/postgres
```

### 2. DATABASE_HOST 格式
```bash
# ✅ 正确格式
DATABASE_HOST=db.[PROJECT_REF].supabase.co

# ❌ 错误格式
DATABASE_HOST=db.https://[PROJECT_REF].supabase.co
DATABASE_HOST=https://[PROJECT_REF].supabase.co
DATABASE_HOST=[PROJECT_REF].supabase.co
```

## 常见错误和解决方案

### 错误 1: 包含 https:// 前缀

**问题**：在主机名中包含了 `https://` 前缀
```bash
# 错误示例
DATABASE_HOST=db.https://srobmfipuqbxlrjgizxk.supabase.co
DATABASE_URL=postgresql://postgres:password@db.https://srobmfipuqbxlrjgizxk.supabase.co:5432/postgres
```

**解决方案**：移除 `https://` 前缀
```bash
# 正确格式
DATABASE_HOST=db.srobmfipuqbxlrjgizxk.supabase.co
DATABASE_URL=postgresql://postgres:password@db.srobmfipuqbxlrjgizxk.supabase.co:5432/postgres
```

### 错误 2: 缺少 db. 前缀

**问题**：主机名缺少 `db.` 前缀
```bash
# 错误示例
DATABASE_HOST=srobmfipuqbxlrjgizxk.supabase.co
```

**解决方案**：添加 `db.` 前缀
```bash
# 正确格式
DATABASE_HOST=db.srobmfipuqbxlrjgizxk.supabase.co
```

### 错误 3: 端口号错误

**问题**：使用了错误的端口号
```bash
# 错误示例
DATABASE_URL=postgresql://postgres:password@db.project.supabase.co:443/postgres
```

**解决方案**：使用正确的端口号 5432
```bash
# 正确格式
DATABASE_URL=postgresql://postgres:password@db.project.supabase.co:5432/postgres
```

## 自动格式验证

我们的设置脚本现在包含自动格式验证功能，可以自动清理常见的格式错误：

### JavaScript 脚本 (setup-env.js)
```javascript
function validateProjectRef(projectRef) {
  let cleanRef = projectRef.trim();
  
  // 移除 https:// 前缀
  if (cleanRef.startsWith('https://')) {
    cleanRef = cleanRef.replace('https://', '');
  }
  
  // 移除 .supabase.co 后缀
  if (cleanRef.endsWith('.supabase.co')) {
    cleanRef = cleanRef.replace('.supabase.co', '');
  }
  
  // 移除 db. 前缀
  if (cleanRef.startsWith('db.')) {
    cleanRef = cleanRef.replace('db.', '');
  }
  
  return cleanRef;
}
```

### Shell 脚本 (quick-setup.sh)
```bash
# 验证和清理项目引用 ID
PROJECT_REF=$(echo "$RAW_PROJECT_REF" | sed 's|^https://||' | sed 's|\.supabase\.co$||' | sed 's|^db\.||')
```

## 手动修复现有配置

如果您已经有一个格式错误的 `.env` 文件，可以使用以下命令快速修复：

### 修复 DATABASE_URL
```bash
# 移除 https:// 前缀
sed -i '' 's|db\.https://|db.|g' .env

# 确保端口号正确
sed -i '' 's|:443/|:5432/|g' .env
```

### 修复 DATABASE_HOST
```bash
# 移除 https:// 前缀
sed -i '' 's|db\.https://|db.|g' .env

# 确保格式正确
sed -i '' 's|^DATABASE_HOST=.*|DATABASE_HOST=db.[PROJECT_REF].supabase.co|g' .env
```

## 验证连接格式

### 1. 检查 .env 文件
```bash
grep -E "(DATABASE_URL|DATABASE_HOST)" .env
```

### 2. 测试连接
```bash
# 使用 psql 测试连接
psql "postgresql://postgres:[PASSWORD]@db.[PROJECT_REF].supabase.co:5432/postgres"

# 或者使用 Node.js 测试
node -e "
const { Client } = require('pg');
const client = new Client({
  connectionString: process.env.DATABASE_URL
});
client.connect()
  .then(() => console.log('✅ 连接成功'))
  .catch(err => console.error('❌ 连接失败:', err.message))
  .finally(() => client.end());
"
```

## 完整的正确配置示例

```bash
# =================================
# 数据库配置 (Supabase PostgreSQL)
# =================================
DATABASE_CLIENT=postgres
DATABASE_URL=postgresql://postgres:your_password@db.your_project_ref.supabase.co:5432/postgres
DATABASE_HOST=db.your_project_ref.supabase.co
DATABASE_PORT=5432
DATABASE_NAME=postgres
DATABASE_USERNAME=postgres
DATABASE_PASSWORD=your_password
DATABASE_SSL=true
DATABASE_SSL_REJECT_UNAUTHORIZED=false
DATABASE_POOL_MIN=2
DATABASE_POOL_MAX=10
DATABASE_CONNECTION_TIMEOUT=60000
DATABASE_SCHEMA=public
```

## 故障排除

### 1. 连接被拒绝
- 检查项目引用 ID 是否正确
- 检查密码是否正确
- 检查网络连接

### 2. SSL 错误
- 确保 `DATABASE_SSL=true`
- 确保 `DATABASE_SSL_REJECT_UNAUTHORIZED=false`

### 3. 超时错误
- 检查防火墙设置
- 检查网络连接
- 增加 `DATABASE_CONNECTION_TIMEOUT` 值

## 总结

正确的 Supabase 连接格式是：
- 主机名：`db.[PROJECT_REF].supabase.co`
- 端口：`5432`
- 协议：`postgresql://`
- 不要包含 `https://` 前缀

使用我们的设置脚本可以自动处理格式验证和清理，避免手动配置时的格式错误。
