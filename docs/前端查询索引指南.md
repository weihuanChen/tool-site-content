# 前端查询索引指南

## 快速参考

### 🔥 高优先级查询字段 (建议建立索引)

| 字段 | 类型 | 查询频率 | 索引建议 | 示例查询 |
|------|------|----------|----------|----------|
| `language` | enum | 极高 | 复合索引 | `filters[language][$eq]=ja` |
| `domain` | string | 高 | 复合索引 | `filters[domain][$eq]=https://16to10.com` |
| `publishedAt` | datetime | 高 | 时间索引 | `sort=publishedAt:desc` |
| `title` | string | 中 | 全文索引 | `filters[title][$contains]=strapi` |
| `username` | string | 中 | 唯一索引 | `filters[username][$eq]=author1` |

### ✅ 推荐复合索引

```sql
-- 最常用查询组合
CREATE INDEX idx_articles_lang_domain_published ON articles(language, domain, publishedAt DESC);

-- 语言 + 时间排序
CREATE INDEX idx_articles_lang_published ON articles(language, publishedAt DESC);

-- 域名 + 时间排序  
CREATE INDEX idx_articles_domain_published ON articles(domain, publishedAt DESC);
```

## 常用查询模式

### 1. 文章列表查询 (最常用)

```javascript
// 基础查询 - 性能优秀
GET /api/articles?filters[language][$eq]=ja&sort=publishedAt:desc&pagination[page]=1&pagination[pageSize]=10

// 多条件查询 - 性能良好
GET /api/articles?filters[language][$eq]=ja&filters[domain][$eq]=https://16to10.com&sort=publishedAt:desc

// 搜索查询 - 性能一般
GET /api/articles?filters[title][$containsi]=数学&filters[language][$eq]=ja
```

**索引需求**: `(language, domain, publishedAt)`

### 2. 作者相关查询

```javascript
// 按作者查询文章 - 性能良好
GET /api/articles?filters[author][id][$eq]=1&sort=publishedAt:desc

// 作者信息查询 - 性能优秀
GET /api/authors?filters[username][$eq]=author1
```

**索引需求**: `author_id`, `username`

### 3. 时间范围查询

```javascript
// 时间范围 - 性能优秀
GET /api/articles?filters[publishedAt][$gte]=2023-01-01&filters[publishedAt][$lte]=2023-12-31

// 最近文章 - 性能优秀
GET /api/articles?filters[publishedAt][$gte]=2023-12-01&sort=publishedAt:desc
```

**索引需求**: `publishedAt`

## 性能优化建议

### 🚀 查询优化

1. **优先使用索引字段过滤**
   ```javascript
   // ✅ 推荐 - 使用索引字段
   filters[language][$eq]=ja
   filters[domain][$eq]=https://16to10.com
   
   // ⚠️ 谨慎使用 - 性能较低
   filters[title][$contains]=strapi
   filters[tags][$contains]=数学
   ```

2. **合理设置分页大小**
   ```javascript
   // ✅ 推荐
   pagination[pageSize]=10  // 列表页
   pagination[pageSize]=25  // 管理页
   
   // ❌ 避免
   pagination[pageSize]=100 // 过大影响性能
   ```

3. **避免深度关联查询**
   ```javascript
   // ✅ 推荐
   populate=author
   
   // ⚠️ 谨慎使用
   populate[author][populate]=profile
   ```

### 📊 缓存策略

```javascript
// 缓存时间建议
const cacheTTL = {
  articles: 300,      // 5分钟 - 文章列表
  article: 1800,      // 30分钟 - 单篇文章
  authors: 3600,      // 1小时 - 作者信息
  search: 60          // 1分钟 - 搜索结果
};
```

### 🔍 监控指标

- **响应时间**: < 200ms (目标)
- **缓存命中率**: > 85%
- **数据库连接**: < 80% 使用率

## 查询构建器示例

```javascript
// 推荐的前端查询构建器
class ArticleQuery {
  constructor() {
    this.filters = {};
    this.sort = 'publishedAt:desc';
    this.pagination = { page: 1, pageSize: 10 };
    this.populate = [];
  }
  
  // 语言过滤 (高优先级索引)
  byLanguage(lang) {
    this.filters.language = { $eq: lang };
    return this;
  }
  
  // 域名过滤 (高优先级索引)
  byDomain(domain) {
    this.filters.domain = { $eq: domain };
    return this;
  }
  
  // 标题搜索 (全文索引)
  searchTitle(keyword) {
    this.filters.title = { $containsi: keyword };
    return this;
  }
  
  // 时间范围 (时间索引)
  byDateRange(start, end) {
    this.filters.publishedAt = { $gte: start, $lte: end };
    return this;
  }
  
  // 排序 (索引字段)
  sortBy(field, direction = 'desc') {
    this.sort = `${field}:${direction}`;
    return this;
  }
  
  // 分页
  paginate(page, size) {
    this.pagination = { page, pageSize: size };
    return this;
  }
  
  // 构建查询参数
  build() {
    const params = new URLSearchParams();
    
    // 添加过滤条件
    Object.entries(this.filters).forEach(([field, condition]) => {
      Object.entries(condition).forEach(([op, value]) => {
        params.append(`filters[${field}][${op}]`, value);
      });
    });
    
    // 添加其他参数
    params.append('sort', this.sort);
    params.append('pagination[page]', this.pagination.page);
    params.append('pagination[pageSize]', this.pagination.pageSize);
    
    if (this.populate.length > 0) {
      this.populate.forEach((rel, index) => {
        params.append(`populate[${index}]`, rel);
      });
    }
    
    return params.toString();
  }
}

// 使用示例
const query = new ArticleQuery()
  .byLanguage('ja')
  .byDomain('https://16to10.com')
  .sortBy('publishedAt', 'desc')
  .paginate(1, 10)
  .build();

// GET /api/articles?filters[language][$eq]=ja&filters[domain][$eq]=https://16to10.com&sort=publishedAt:desc&pagination[page]=1&pagination[pageSize]=10
```

## 错误处理

```javascript
// API错误处理
const handleAPIError = (error) => {
  if (error.status === 404) {
    console.warn('资源不存在');
  } else if (error.status === 429) {
    console.warn('请求过于频繁，请稍后重试');
  } else if (error.status >= 500) {
    console.error('服务器错误，请稍后重试');
  }
};
```

## 总结

### 关键要点
1. **优先使用高优先级索引字段** (`language`, `domain`, `publishedAt`)
2. **合理设置分页大小** (10-25条)
3. **实施适当的缓存策略**
4. **监控查询性能指标**

### 避免的操作
1. ❌ 大量数据的 `$contains` 查询
2. ❌ 过大的分页大小 (>50条)
3. ❌ 深度嵌套的关联查询
4. ❌ 频繁的实时查询 (无缓存)

通过遵循这些指南，可以确保前端查询的高性能和良好用户体验。
